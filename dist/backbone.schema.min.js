/**
 * Backbone.Schema v0.4.3
 * https://github.com/DreamTheater/Backbone.Schema
 *
 * Copyright (c) 2013 Dmytro Nemoga
 * Released under the MIT license
 */
!function(a){"use strict";var b=Backbone.Schema=function(c){return this instanceof b?(a=_.extend(this,{model:c},{handlers:{}}),_.extend(c,{toJSON:_.wrap(c.toJSON,function(a,b){var c=a.call(this,b);return _.each(c,function(a,c,d){a instanceof Backbone.Model?a=a.source?a.id:a.toJSON(b):a instanceof Backbone.Collection&&(a=a.source?_.pluck(a.models,"id"):a.toJSON(b)),d[c]=a}),c}),get:_.wrap(c.get,function(b,c){var d=(a.handlers[c]||{}).getter,e=b.call(this,c);return d?d(c,e):this.attributes[c]}),set:_.wrap(c.set,function(b,c,d,e){var f;!c||_.isObject(c)?(f=c,e=d):(f={})[c]=d;var g={};return _.each(f,function(b,c,d){var e=(a.handlers[c]||{}).setter,f=e?e(c,b):_.pick(d,c);_.each(f,function(a,b){g[b]=a})}),b.call(this,g,e)})}),void 0):new b(c)};_.extend(b,{handlers:{string:{getter:function(a,b){return b},setter:function(a,b){return String(b)}},"boolean":{getter:function(a,b){return b},setter:function(a,b){return Boolean(b)}},number:{getter:function(a,b,c){var d=c.format||"n",e=c.culture;return Globalize.format(b,d,e)},setter:function(a,b,c){var d=c.culture;return b=String(b),Globalize.parseFloat(b,d)||Number(b)}},datetime:{getter:function(a,b,c){var d=c.format||"d",e=c.culture;return b=new Date(b),Globalize.format(b,d,e)},setter:function(a,b,c){var d=c.format||"d",e=c.culture,f=c.standard;b=Globalize.parseDate(b,d,e)||new Date(b);var g;switch(f){case"unix":g=b.getTime();break;default:try{g=b.toISOString()}catch(h){g=b.toString()}}return g}},locale:{getter:function(a,b,c){var d=c.culture;return Globalize.localize(b,d)||b},setter:function(a,b,c){var d=c.culture;b=String(b);var e,f=Globalize.findClosestCulture(d).messages,g=_.pairs(f);return e=_.find(g,function(a){return a[1]===b}),e?e[0]:b}},text:{getter:function(a,b){return _.unescape(b)},setter:function(a,b){return b=_.unescape(b),_.escape(b)}},model:{getter:function(a,b){return b},setter:function(a,b,c){var d,e=c.source,f=c.clear;d=c.model||e.model;var g=this.get(a),h=e?e.get(b):b;return h instanceof d?g=h:g instanceof d?f?g.clear().set(h,c):g.set(h,c):g=new d(h,c),g.source=e||null,g}},collection:{getter:function(a,b){return b},setter:function(a,b,c){var d,e=c.source,f=c.reset;d=c.collection||e.constructor;var g=this.get(a),h=e?e.filter(function(a){return _.contains(b,a.id)}):b;return g instanceof d?f?g.reset(h,c):g.set(h,c):g=new d(h,c),g.source=e||null,g}}}}),_.extend(b.prototype,{constructor:b,define:function(a,b){var c;return!a||_.isObject(a)?c=a:(c={})[a]=b,_.each(c,function(a,b){a=a||{},this._addHandlers(b,a)},this),this.refresh(),this},refresh:function(){var a=this.handlers,b={};return _.each(a,function(a,c){b[c]=this.model.attributes[c]},this),this.model.set(b),this},defaultValue:function(a){var b=_.result(this.model,"defaults")||{};return _.has(b,a)?b[a]:null},_addHandlers:function(b,c){var d=c.type,e=c.array,f=c.model,g=c.collection;d||(e?d=e:f?d="model":g&&(d="collection"));var h=this.constructor.handlers[d]||{};this.handlers[b]=_.defaults(c,{getter:_.wrap(h.getter,function(a,b,d){var f=[],g=e?d:[d];return _.each(g,function(d){var e;e=_.isNull(d)?d:a?a.call(this,b,d,c):d,f.push(e)},this),e?f:f[0]}),setter:_.wrap(h.setter,function(b,f,g){var h=[],i=e?g:[g];return _.each(i,function(e){_.isUndefined(e)&&(e=a.defaultValue(f));var g;if(_.isNull(e))switch(d){case"model":g=b?b.call(this,f,{},c):e;break;case"collection":g=b?b.call(this,f,[],c):e;break;default:g=e}else g=b?b.call(this,f,e,c):e;h.push(g)},this),_.object([f],[e?h:h[0]])})}),this._bindCallbacks(c)},_bindCallbacks:function(a){var b=a.getter,c=a.setter,d=this.model;b&&(a.getter=_.bind(b,d)),c&&(a.setter=_.bind(c,d))}})}();